
// ============================================================================
// PRISMA SCHEMA para Next.js + PostgreSQL
// Projeto: Cake & Cia - Sistema de Delivery de Cupcakes
// Compatible with: Prisma 5.x
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// MODELS
// ============================================================================

model User {
  id            Int       @id @default(autoincrement())
  uuid          String    @unique @default(uuid()) @db.Uuid
  username      String    @unique @db.VarChar(50)
  email         String    @unique @db.VarChar(100)
  passwordHash  String    @map("password_hash") @db.VarChar(255)
  fullName      String    @map("full_name") @db.VarChar(100)
  birthDate     DateTime? @map("birth_date") @db.Date
  cpf           String?   @unique @db.VarChar(14)
  phone         String?   @db.VarChar(20)
  emailVerified Boolean   @default(false) @map("email_verified")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamp
  lastLogin     DateTime? @map("last_login") @db.Timestamp

  // Relations
  addresses      Address[]
  orders         Order[]
  reviews        ProductReview[]
  wishlists      Wishlist[]
  sessions       Session[]

  @@index([username])
  @@index([email])
  @@index([cpf])
  @@index([createdAt])
  @@map("users")
}

model Address {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  street       String   @db.VarChar(200)
  number       String   @db.VarChar(10)
  neighborhood String   @db.VarChar(100)
  complement   String?  @db.VarChar(100)
  city         String   @db.VarChar(100)
  state        String   @db.VarChar(2)
  zipcode      String   @db.VarChar(9)
  isDefault    Boolean  @default(false) @map("is_default")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamp

  // Relations
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]

  @@index([userId])
  @@index([userId, isDefault])
  @@map("addresses")
}

model Product {
  id            Int      @id @default(autoincrement())
  slug          String   @unique @db.VarChar(100)
  name          String   @db.VarChar(100)
  description   String?  @db.Text
  price         Decimal  @db.Decimal(10, 2)
  imageUrl      String?  @map("image_url") @db.VarChar(255)
  category      String?  @db.VarChar(50)
  stockQuantity Int      @default(0) @map("stock_quantity")
  isAvailable   Boolean  @default(true) @map("is_available")
  isFeatured    Boolean  @default(false) @map("is_featured")
  sortOrder     Int      @default(0) @map("sort_order")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamp

  // Relations
  orderItems OrderItem[]
  reviews    ProductReview[]
  wishlists  Wishlist[]

  @@index([category])
  @@index([isAvailable])
  @@index([isFeatured])
  @@index([slug])
  @@map("products")
}

enum PaymentMethod {
  money
  credit_card @map("credit-card")
  pix
}

enum PaymentStatus {
  pending
  processing
  paid
  failed
  refunded
}

enum OrderStatus {
  pending
  confirmed
  preparing
  ready
  delivering
  delivered
  cancelled
}

model Order {
  id            Int           @id @default(autoincrement())
  orderNumber   String        @unique @map("order_number") @db.VarChar(20)
  userId        Int           @map("user_id")
  addressId     Int           @map("address_id")
  subtotal      Decimal       @db.Decimal(10, 2)
  deliveryFee   Decimal       @default(0) @map("delivery_fee") @db.Decimal(10, 2)
  discount      Decimal       @default(0) @db.Decimal(10, 2)
  totalAmount   Decimal       @map("total_amount") @db.Decimal(10, 2)
  paymentMethod PaymentMethod @map("payment_method")
  paymentStatus PaymentStatus @default(pending) @map("payment_status")
  orderStatus   OrderStatus   @default(pending) @map("order_status")
  notes         String?       @db.Text
  createdAt     DateTime      @default(now()) @map("created_at") @db.Timestamp
  updatedAt     DateTime      @updatedAt @map("updated_at") @db.Timestamp
  confirmedAt   DateTime?     @map("confirmed_at") @db.Timestamp
  deliveredAt   DateTime?     @map("delivered_at") @db.Timestamp
  cancelledAt   DateTime?     @map("cancelled_at") @db.Timestamp

  // Relations
  user         User           @relation(fields: [userId], references: [id])
  address      Address        @relation(fields: [addressId], references: [id])
  items        OrderItem[]
  payments     Payment[]
  history      OrderHistory[]

  @@index([userId])
  @@index([orderStatus])
  @@index([paymentStatus])
  @@index([createdAt(sort: Desc)])
  @@index([orderNumber])
  @@map("orders")
}

model OrderItem {
  id           Int      @id @default(autoincrement())
  orderId      Int      @map("order_id")
  productId    Int      @map("product_id")
  productName  String   @map("product_name") @db.VarChar(100)
  productPrice Decimal  @map("product_price") @db.Decimal(10, 2)
  quantity     Int
  unitPrice    Decimal  @map("unit_price") @db.Decimal(10, 2)
  subtotal     Decimal  @db.Decimal(10, 2)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model Employee {
  id           Int       @id @default(autoincrement())
  uuid         String    @unique @default(uuid()) @db.Uuid
  username     String    @unique @db.VarChar(50)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  fullName     String    @map("full_name") @db.VarChar(100)
  email        String?   @unique @db.VarChar(100)
  role         String    @default("staff") @db.VarChar(50)
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamp
  lastLogin    DateTime? @map("last_login") @db.Timestamp

  // Relations
  orderHistory OrderHistory[]
  sessions     Session[]

  @@index([username])
  @@index([role])
  @@index([isActive])
  @@map("employees")
}

model Payment {
  id              Int       @id @default(autoincrement())
  orderId         Int       @map("order_id")
  paymentMethod   String    @map("payment_method") @db.VarChar(20)
  amount          Decimal   @db.Decimal(10, 2)
  status          String    @default("pending") @db.VarChar(20)
  transactionId   String?   @map("transaction_id") @db.VarChar(100)
  gatewayResponse Json?     @map("gateway_response") @db.JsonB
  paidAt          DateTime? @map("paid_at") @db.Timestamp
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamp

  // Relations
  order Order @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([status])
  @@index([transactionId])
  @@map("payments")
}

model OrderHistory {
  id         Int       @id @default(autoincrement())
  orderId    Int       @map("order_id")
  oldStatus  String?   @map("old_status") @db.VarChar(20)
  newStatus  String    @map("new_status") @db.VarChar(20)
  changedBy  Int?      @map("changed_by_employee_id")
  notes      String?   @db.Text
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamp

  // Relations
  order    Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  employee Employee? @relation(fields: [changedBy], references: [id])

  @@index([orderId])
  @@index([createdAt(sort: Desc)])
  @@map("order_history")
}

model ProductReview {
  id                 Int      @id @default(autoincrement())
  productId          Int      @map("product_id")
  userId             Int      @map("user_id")
  orderId            Int?     @map("order_id")
  rating             Int
  title              String?  @db.VarChar(100)
  comment            String?  @db.Text
  isVerifiedPurchase Boolean  @default(false) @map("is_verified_purchase")
  isPublished        Boolean  @default(true) @map("is_published")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamp
  updatedAt          DateTime @updatedAt @map("updated_at") @db.Timestamp

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@index([productId])
  @@index([userId])
  @@index([rating])
  @@map("product_reviews")
}

model Wishlist {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  productId Int      @map("product_id")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@map("wishlists")
}

model Session {
  id           Int       @id @default(autoincrement())
  sessionToken String    @unique @map("session_token") @db.VarChar(255)
  userId       Int?      @map("user_id")
  employeeId   Int?      @map("employee_id")
  expires      DateTime  @db.Timestamp
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamp

  // Relations
  user     User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  employee Employee? @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([sessionToken])
  @@index([userId])
  @@index([employeeId])
  @@map("sessions")
}

// ============================================================================
// VIEWS (Não suportado diretamente no Prisma, usar Raw SQL)
// ============================================================================
// Para usar as views criadas no SQL, você pode usar Prisma Raw Queries:
// await prisma.$queryRaw`SELECT * FROM vw_orders_summary`
